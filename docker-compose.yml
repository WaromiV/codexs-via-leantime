services:
  leantime:
    image: leantime/leantime:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "3001:3001"
    environment:
      LEAN_APP_URL: http://localhost:8080
      LEAN_DEBUG: 0
      LEAN_DB_HOST: mariadb
      LEAN_DB_USER: leantime
      LEAN_DB_PASSWORD: leantime_pw
      LEAN_DB_DATABASE: leantime
      LEAN_DB_PORT: 3306
      LEAN_SESSION_PASSWORD: change_me_session_salt
      MCP_SERVER_ENABLED: "true"
      MCP_TRANSPORT: http
      MCP_SERVER_HOST: 0.0.0.0
      MCP_SERVER_PORT: "3001"
      MCP_REQUIRE_AUTH: "false"
      MCP_REQUIRED_ROLE: editor
      MCP_RATE_LIMIT: "100"
      MCP_MAX_EXECUTION_TIME: "30"
      MCP_MEMORY_LIMIT: 256M
      MCP_MAX_RESPONSE_SIZE: "10485760"
    volumes:
      - leantime_storage:/var/www/html/storage
    networks:
      - appnet
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  mariadb:
    image: mariadb:10.11
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: leantime_root
      MYSQL_DATABASE: leantime
      MYSQL_USER: leantime
      MYSQL_PASSWORD: leantime_pw
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - appnet
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 5s
      retries: 5

  gitea:
    image: gitea/gitea:1.22.0-rootless
    restart: unless-stopped
    ports:
      - "3000:3000"
      - "2222:2222"
    environment:
      USER_UID: "1000"
      USER_GID: "1000"
      GITEA_APP_INI: /var/lib/gitea/custom/conf/app.ini
      GITEA__server__ROOT_URL: http://localhost:3000/
      GITEA__server__SSH_DOMAIN: localhost
      GITEA__database__DB_TYPE: sqlite3
      GITEA__security__INSTALL_LOCK: "true"
      # Set this after first-run setup to enable MCP auth
      # GITEA_ACCESS_TOKEN: ""
    volumes:
      - gitea_data:/var/lib/gitea
    networks:
      - appnet
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  gitea_mcp:
    image: gitea/gitea-mcp-server:latest
    restart: unless-stopped
    depends_on:
      - gitea
    environment:
      GITEA_HOST: http://gitea:3000
      # Temporary broken token placeholder
      GITEA_ACCESS_TOKEN: "broken-token-placeholder"
    command: ["/app/gitea-mcp", "-t", "http", "--port", "8082", "--host", "http://gitea:3000"]
    ports:
      - "8082:8082"
    networks:
      - appnet

volumes:
  leantime_storage:
  gitea_data:
  mariadb_data:

networks:
  appnet:
    driver: bridge
